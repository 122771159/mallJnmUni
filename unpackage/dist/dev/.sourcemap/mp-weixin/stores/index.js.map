{"version":3,"file":"index.js","sources":["stores/index.js"],"sourcesContent":["import { ref, computed } from \"vue\";\nimport { defineStore } from \"pinia\";\n\nexport const useUserStore = defineStore(\"user\", () => {\n  const token = ref(uni.getStorageSync(\"token\") || \"\");\n  const roles = ref(uni.getStorageSync(\"roles\") || \"\");\n  const userInfo = ref(uni.getStorageSync(\"userInfo\") || \"\");\n  const cart = ref(uni.getStorageSync(\"cart\") || []);\n  const tokenTimestamp = ref(uni.getStorageSync(\"tokenTimestamp\") || 0);\n  const tokenExpiresIn = ref(\n    uni.getStorageSync(\"tokenExpiresIn\") || 7200 * 1000\n  );\n  function addCart(product) {\n    //添加商品到购物车\n    const index = cart.value.findIndex((item) => item.id === product.id);\n    if (index !== -1) {\n      cart.value[index].count += 1;\n    } else {\n      product.count = 1;\n      cart.value.push(product);\n    }\n    uni.setStorageSync(\"cart\", cart.value);\n  }\n  function setCart(product, count) {\n    //直接设置某个商品和数量到购物车，\n    product.count = count;\n    const index = cart.value.findIndex((item) => item.id === product.id);\n    if (count > 0) {\n      if (index !== -1) {\n        cart.value[index] = product;\n      } else {\n        cart.value.push(product);\n      }\n    } else {\n      if (index !== -1) {\n        cart.value.splice(index, 1);\n      }\n    }\n    uni.setStorageSync(\"cart\", cart.value);\n  }\n  function removeCart(product) {\n    // 从购物车中移除商品\n    const index = cart.value.findIndex((item) => item.id === product.id);\n    if (index !== -1) {\n      cart.value[index].count -= 1;\n      if (cart.value[index].count <= 0) {\n        cart.value.splice(index, 1);\n      }\n    }\n    uni.setStorageSync(\"cart\", cart.value);\n  }\n  function clearCart() {\n    // 清空购物车\n    cart.value = [];\n    uni.setStorageSync(\"cart\", cart.value);\n  }\n  function getCount(product) {\n    // 获取购物车中某个商品的数量\n    const index = cart.value.findIndex((item) => item.id === product.id);\n    if (index !== -1) {\n      return cart.value[index].count;\n    }\n    return 0;\n  }\n  function setToken(token_) {\n    // 设置token\n    token_ = \"Bearer \" + token_;\n    uni.setStorageSync(\"token\", token_);\n    token.value = token_;\n  }\n  function setTokenExpiresIn(tokenExpiresIn_) {\n    tokenExpiresIn.value = tokenExpiresIn_;\n    uni.setStorageSync(\"tokenExpiresIn\", tokenExpiresIn_);\n  }\n  function setTokenTimestamp(tokenTimestamp_) {\n    tokenTimestamp.value = tokenTimestamp_;\n    uni.setStorageSync(\"tokenTimestamp\", tokenTimestamp_);\n  }\n  function setRoles(roles_) {\n    // 设置角色\n    uni.setStorageSync(\"roles\", roles_);\n    roles.value = roles_;\n  }\n  function setUserInfo(userInfo_) {\n    // 设置用户信息\n    userInfo_ = JSON.stringify(userInfo_);\n    userInfo.value = userInfo_;\n    uni.setStorageSync(\"userInfo\", userInfo_);\n  }\n  function logout() {\n    // 退出登录\n    uni.removeStorageSync(\"token\");\n    uni.removeStorageSync(\"roles\");\n    uni.removeStorageSync(\"userInfo\");\n    uni.removeStorageSync(\"tokenTimestamp\");\n    uni.removeStorageSync(\"tokenExpiresIn\");\n    clearCart();\n    token.value = \"\";\n    roles.value = \"\";\n    userInfo.value = {};\n  }\n  function wxlogin() {\n    return new Promise((resolve, reject) => {\n      uni.$com.toast({\n        type: \"loading\",\n      });\n      uni.login({\n        provider: \"weixin\",\n        success: async function (loginRes) {\n          const { data: openId } = await uni.$http.get(\n            `/wx/getOpenid/${loginRes.code}`\n          );\n          uni.$http\n            .post(\"/login\", {\n              userType: \"CUSTOMER\",\n              openId,\n            })\n            .then((res) => {\n              setToken(res.data.token);\n              setUserInfo(res.data.user);\n              setRoles(res.data.roles);\n              setTokenExpiresIn(res.data.tokenExpiresIn);\n              setTokenTimestamp(Date.now());\n              uni.$com.toastHide();\n              resolve(\"success\");\n            })\n            .catch(() => {\n              uni.$com.toastHide();\n              reject(\"微信一键登录失败\");\n            });\n        },\n        fail: function () {\n          uni.$com.toastHide();\n          uni.$com.toast({\n            type: \"error\",\n            message: \"登录失败\",\n          });\n          reject(\"微信一键登录失败\");\n        },\n      });\n    });\n  }\n  const isLogin = computed(() => token.value !== \"\"); // 是否登录\n  const getToken = computed(() => token.value); // 获取token\n  const getRoles = computed(() => roles.value); // 获取角色\n  const isSales = computed(() => {\n    // 是否是销售\n    return roles.value.includes(\"SALES\");\n  });\n  const getUserInfo = computed(() => JSON.parse(userInfo.value)); // 获取用户信息\n  return {\n    getToken,\n    getRoles,\n    setToken,\n    setRoles,\n    logout,\n    setUserInfo,\n    isLogin,\n    isSales,\n    getUserInfo,\n    addCart,\n    removeCart,\n    clearCart,\n    getCount,\n    cart,\n    setCart,\n    setTokenExpiresIn,\n    setTokenTimestamp,\n    tokenTimestamp,\n    tokenExpiresIn,\n    wxlogin,\n  };\n});\n"],"names":["defineStore","ref","uni","computed"],"mappings":"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"}